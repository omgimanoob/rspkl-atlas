<!DOCTYPE html>
<html lang="en" class="dark bg-gray-900 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <title>[Demo] RSPKL Atlas — Project Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://unpkg.com/feather-icons"></script>

  <script type="module">
    async function loadProjects() {
      const res = await fetch('/projects');
      const projects = await res.json();
      const table = document.querySelector('#projectTableBody');

      projects.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = "border-b border-gray-700 hover:bg-gray-800 transition";

        const formId = `form-${row.id}`;

        tr.innerHTML = `
          <td class="px-4 py-3 font-medium">${row.name || ''}</td>
          <td class="px-4 py-3">${row.moneyCollected || 0}</td>
          <td class="px-4 py-3">${getStatusPill(row.status)}</td>
          <td class="px-4 py-3">
            <button 
              class="flex items-center gap-1 text-sm px-3 py-1 border border-gray-600 rounded hover:bg-gray-700"
              onclick="toggleForm('${formId}')">
              <svg data-feather="edit" class="w-4 h-4"></svg> Edit
            </button>
          </td>
        `;
        table.appendChild(tr);

        const formTr = document.createElement('tr');
        formTr.id = formId;
        formTr.className = "hidden bg-gray-800/50";
        formTr.innerHTML = `
<td colspan="4" class="px-8 py-6 border-l-4 border-blue-600">
  <form onsubmit="submitForm(event, ${row.id})" class="space-y-4">
   <!-- Grouped row: Money, Status, Visibility -->
<div class="flex flex-wrap gap-4">
  <!-- Visibility toggle -->
  <div class="flex-auto min-w-[200px] max-w-sm">
    <label class="block mb-1 font-medium flex items-center gap-1">
      <svg data-feather="eye" class="w-4 h-4"></svg> Visibility
    </label>
    <label class="inline-flex items-center gap-2">
      <input 
        type="checkbox" disabled class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-0"
        ${row.isProspective ? '' : 'checked'}
      />
      <span class="text-sm text-gray-400">
        ${row.isProspective 
          ? 'Private only to director'
          : 'Visible to all users'
        }
      </span>
    </label>
  </div>

  <!-- Status -->
  <div class="flex-auto min-w-[200px] max-w-sm">
    <label class="block mb-1 font-medium flex items-center gap-1">
      <svg data-feather="tag" class="w-4 h-4"></svg> Status
    </label>
    <select 
      class="w-full border border-gray-600 rounded px-3 py-2 bg-gray-900 focus:outline-none focus:ring focus:border-blue-500"
      id="status-${row.id}">
      ${[
        'Unassigned',
        'Schematic Design',
        'Design Development',
        'Tender',
        'Under construction',
        'Post construction',
        'KIV',
        'Others'
      ].map(status =>
        `<option 
          class="${getStatusColor(status)}"
          value="${status}" 
          ${row.status === status ? 'selected' : ''}>
          ${status}
        </option>`
      ).join('')}
    </select>
  </div>

  <!-- Money Collected -->
  <div class="flex-auto min-w-[200px] max-w-sm">
    <label class="block mb-1 font-medium flex items-center gap-1">
      <svg data-feather="dollar-sign" class="w-4 h-4"></svg> Collected
    </label>
    <div class="flex">
      <span class="inline-flex items-center px-3 border border-r-0 border-gray-600 bg-gray-800 rounded-l">MYR</span>
      <input 
        type="number"
        class="w-full p-2 border border-gray-600 rounded-r bg-gray-900 text-gray-100"
        value="${row.moneyCollected || 0}"
      />
    </div>
  </div>
</div>


    <!-- Private Remarks -->
    <div>
      <label class="block mb-1 font-medium flex items-center gap-1">
        <svg data-feather="file-text" class="w-4 h-4"></svg> Private Remarks
      </label>
      <textarea         
        rows="2"
        class="w-full p-2 border border-gray-600 rounded bg-gray-900 text-gray-100"
      >No remarks yet. Add your them here.</textarea>
    </div>

    <!-- Public Comment -->
    <div>
      <label class="block mb-1 font-medium flex items-center gap-1">
        <svg data-feather="file-text" class="w-4 h-4"></svg> Comment
      </label>
      <textarea 
        disabled
        rows="2"
        class="bg-gray-800 border border-gray-600 text-gray-400 p-2 rounded w-full opacity-50 cursor-not-allowed"
      >${row.comment || 'No notes yet. Add your comment here.'}</textarea>
    </div>

    <!-- Billable status -->
    <div>
      <div class="flex items-center gap-2">
        ${row.billable 
          ? `<svg data-feather="check-circle" class="w-5 h-5 text-green-400"></svg> 
             <span class="text-green-400 font-semibold">Billable</span>`
          : `<svg data-feather="x-circle" class="w-5 h-5 text-red-400"></svg> 
             <span class="text-red-400 font-semibold">Non-Billable</span>`
        }
      </div>
    </div>

    <!-- Save -->
    <button type="submit" class="px-4 py-2 border rounded border-gray-600 hover:bg-gray-700 flex items-center gap-1">
      <svg data-feather="save" class="w-4 h-4"></svg> Save
    </button>
  </form>
</td>`;
        table.appendChild(formTr);
      });

      feather.replace();
    }

    function getStatusColor(status) {
      switch (status) {
        case 'Schematic Design': return 'text-blue-400';
        case 'Design Development': return 'text-indigo-400';
        case 'Tender': return 'text-purple-400';
        case 'Under construction': return 'text-yellow-400';
        case 'Post construction': return 'text-green-400';
        case 'KIV': return 'text-red-400';
        case 'Others': return 'text-gray-400';
        default: return 'text-gray-500';
      }
    }

    function getStatusPill(status) {
      const color = getStatusColor(status);
      return `<span class="inline-flex items-center px-2 py-1 rounded-full border border-gray-600 ${color}">
                ${status || 'Unassigned'}
              </span>`;
    }

    window.updateStatus = async (id, status) => {
      await fetch('/overrides/status', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ kimai_project_id: id, status })
      });
      alert(`✅ Updated Project ${id} → ${status}`);
    };

    window.toggleForm = (formId) => {
      const formRow = document.getElementById(formId);
      formRow.classList.toggle('hidden');
    };

    window.submitForm = (event, id) => {
      event.preventDefault();
      const status = document.getElementById(`status-${id}`).value;
      updateStatus(id, status);
      toggleForm(`form-${id}`);
    };

    window.onload = loadProjects;
  </script>
</head>

<body class="max-w-6xl mx-auto p-8">
  <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
    <svg data-feather="layers" class="w-6 h-6"></svg>
    [Demo] RSPKL Atlas — Project Details
  </h1>

  <table class="w-full border border-gray-700 rounded-lg overflow-hidden">
    <thead class="bg-gray-800">
      <tr>
        <th class="text-left px-4 py-3">Project Name</th>
        <th class="text-left px-4 py-3">Money Collected</th>
        <th class="text-left px-4 py-3">Status</th>
        <th class="text-left px-4 py-3">Actions</th>
      </tr>
    </thead>
    <tbody id="projectTableBody"></tbody>
  </table>
</body>
</html>
